#!/bin/bash
# Vulnerability Scanning Script
# Runs security scans on the codebase and dependencies

set -e

SCAN_DIR="${SCAN_DIR:-.}"
OUTPUT_DIR="${OUTPUT_DIR:-./security-scans}"
LOG_FILE="${LOG_FILE:-$OUTPUT_DIR/scan-$(date +%Y%m%d-%H%M%S).log}"

mkdir -p "$OUTPUT_DIR"

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Dependency scanning with safety (Python)
scan_python_dependencies() {
    log "Scanning Python dependencies for vulnerabilities..."
    
    if command -v safety &> /dev/null; then
        safety check --json > "$OUTPUT_DIR/python-dependencies.json" 2>&1 || true
        safety check > "$OUTPUT_DIR/python-dependencies.txt" 2>&1 || true
        log "Python dependency scan completed"
    else
        log "WARNING: safety not installed. Install with: pip install safety"
    fi
}

# Docker image scanning
scan_docker_images() {
    log "Scanning Docker images for vulnerabilities..."
    
    if command -v trivy &> /dev/null; then
        # Scan backend image
        if [ -f "ops/docker/Dockerfile.backend" ]; then
            trivy image --format json -o "$OUTPUT_DIR/docker-backend.json" \
                $(docker build -q -f ops/docker/Dockerfile.backend .) || true
            trivy image -o "$OUTPUT_DIR/docker-backend.txt" \
                $(docker build -q -f ops/docker/Dockerfile.backend .) || true
        fi
        
        # Scan frontend image
        if [ -f "ops/docker/Dockerfile.frontend" ]; then
            trivy image --format json -o "$OUTPUT_DIR/docker-frontend.json" \
                $(docker build -q -f ops/docker/Dockerfile.frontend .) || true
            trivy image -o "$OUTPUT_DIR/docker-frontend.txt" \
                $(docker build -q -f ops/docker/Dockerfile.frontend .) || true
        fi
        
        log "Docker image scan completed"
    else
        log "WARNING: trivy not installed. Install from: https://github.com/aquasecurity/trivy"
    fi
}

# Code security scanning with bandit (Python)
scan_python_code() {
    log "Scanning Python code for security issues..."
    
    if command -v bandit &> /dev/null; then
        bandit -r backend/ -f json -o "$OUTPUT_DIR/python-code.json" || true
        bandit -r backend/ -f txt -o "$OUTPUT_DIR/python-code.txt" || true
        log "Python code scan completed"
    else
        log "WARNING: bandit not installed. Install with: pip install bandit"
    fi
}

# Secret scanning
scan_secrets() {
    log "Scanning for exposed secrets..."
    
    if command -v trufflehog &> /dev/null; then
        trufflehog filesystem "$SCAN_DIR" --json > "$OUTPUT_DIR/secrets.json" 2>&1 || true
        trufflehog filesystem "$SCAN_DIR" > "$OUTPUT_DIR/secrets.txt" 2>&1 || true
        log "Secret scan completed"
    else
        log "WARNING: trufflehog not installed. Install from: https://github.com/trufflesecurity/trufflehog"
    fi
}

# Main scanning process
main() {
    log "Starting vulnerability scanning"
    log "Output directory: $OUTPUT_DIR"
    
    # Run all scans
    scan_python_dependencies
    scan_python_code
    scan_docker_images
    scan_secrets
    
    log "Vulnerability scanning completed"
    log "Results available in: $OUTPUT_DIR"
    
    # Summary
    echo ""
    echo "=== Scan Summary ==="
    echo "Results directory: $OUTPUT_DIR"
    echo "Log file: $LOG_FILE"
    echo ""
    echo "Review the following files:"
    echo "  - python-dependencies.txt: Python dependency vulnerabilities"
    echo "  - python-code.txt: Python code security issues"
    echo "  - docker-backend.txt: Backend Docker image vulnerabilities"
    echo "  - docker-frontend.txt: Frontend Docker image vulnerabilities"
    echo "  - secrets.txt: Exposed secrets"
}

main "$@"

